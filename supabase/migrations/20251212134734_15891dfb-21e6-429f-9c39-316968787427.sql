-- Legal Doc Builder Tables

-- Legal Templates table (admin-managed)
CREATE TABLE public.legal_templates (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  version TEXT NOT NULL DEFAULT 'v1',
  body_text TEXT NOT NULL,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Legal Doc Instances table
CREATE TABLE public.legal_doc_instances (
  id UUID NOT NULL DEFAULT gen_random_uuid() PRIMARY KEY,
  template_id UUID NOT NULL REFERENCES public.legal_templates(id) ON DELETE RESTRICT,
  status TEXT NOT NULL DEFAULT 'draft' CHECK (status IN ('draft', 'submitted', 'admin_review', 'finalized')),
  purchaser_user_id UUID REFERENCES auth.users(id),
  purchaser_email TEXT,
  field_values_json JSONB NOT NULL DEFAULT '{}',
  computed_values_json JSONB NOT NULL DEFAULT '{}',
  rendered_text_cache TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);

-- Enable RLS
ALTER TABLE public.legal_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.legal_doc_instances ENABLE ROW LEVEL SECURITY;

-- RLS for legal_templates (admin only)
CREATE POLICY "Admins can manage legal templates" 
ON public.legal_templates 
FOR ALL 
USING (
  EXISTS (
    SELECT 1 FROM public.user_roles 
    WHERE user_id = auth.uid() 
    AND role IN ('admin', 'super_admin')
  )
);

CREATE POLICY "Anyone can read legal templates" 
ON public.legal_templates 
FOR SELECT 
USING (true);

-- RLS for legal_doc_instances
CREATE POLICY "Purchasers can manage their own draft instances" 
ON public.legal_doc_instances 
FOR ALL 
USING (
  (purchaser_user_id = auth.uid() AND status IN ('draft', 'submitted'))
  OR purchaser_email = (SELECT email FROM auth.users WHERE id = auth.uid())
);

CREATE POLICY "Admins can manage all instances" 
ON public.legal_doc_instances 
FOR ALL 
USING (
  EXISTS (
    SELECT 1 FROM public.user_roles 
    WHERE user_id = auth.uid() 
    AND role IN ('admin', 'super_admin')
  )
);

-- Trigger for updated_at
CREATE OR REPLACE FUNCTION public.update_legal_doc_instances_updated_at()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = 'public'
AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$;

CREATE TRIGGER update_legal_doc_instances_updated_at
BEFORE UPDATE ON public.legal_doc_instances
FOR EACH ROW
EXECUTE FUNCTION public.update_legal_doc_instances_updated_at();

-- Seed the Common Stock Purchase Agreement template
INSERT INTO public.legal_templates (name, version, body_text)
VALUES (
  'Common Stock Purchase Agreement',
  'v1',
  E'COMMON STOCK PURCHASE AGREEMENT\nTHIS COMMON STOCK PURCHASE AGREEMENT (this \"Agreement\") is made and entered\ninto as of October 29th, 2025, by and between Andrew Appleton (\"Seller\"), on the one hand, and [PURCHASER_NAME] (\"Buyer\"), on the other hand. All terms not otherwise defined herein shall have the meaning set\nforth in that certain Stockholders'' Agreement, dated May 20, 2025, by and among Parade Deck Holdings,\nInc., a Delaware corporation (the \"Company\"), and holders of Capital Stock of the Company identified\ntherein (the \"Stockholders'' Agreement\").\nRECITALS\nA. Seller desires to sell all of his right, title, and interest in an aggregate of [NUMBER_OF_SHARES] shares of\ncommon stock, par value $0.0001 per share, (\"Common Stock\") of the Company to Buyer. The shares of\nCommon Stock sold hereunder are referred to as the \"Purchased Shares.\"\nB. Buyer desires to purchase the Purchased Shares as herein described on the terms and\nconditions hereinafter set forth.\nAGREEMENT\nNOW, THEREFORE, in consideration of the foregoing recitals and the mutual obligations set forth\nin this Agreement, the parties hereto agree as follows:\n1. Purchase and Sale of the Purchased Shares. Subject to the terms and conditions of this\nAgreement, at the \"Closing\" (as hereinafter defined), Seller agrees to sell, convey, transfer, and assign to\nBuyer, and Buyer agrees to purchase from Seller, the Purchased Shares at a purchase price of $[PRICE_PER_SHARE] per\nshare (or an aggregate of $[PURCHASE_AMOUNT]) (the \"Purchase Price\").\n2. Closing. Subject to the terms and conditions of this Agreement, the consummation of the\ntransaction contemplated by this Agreement (the \"Closing\") shall take place remotely by exchange of\ndocuments and signatures (or their electronic counterparts) within three (3) business days of the satisfaction\nof the conditions set forth below. The date on which the Closing is to occur is herein referred to as the\n\"Closing Date.\"\n(a) Conditions Precedent. The obligations of Buyer and Seller to consummate the\ntransactions contemplated by this Agreement are subject to the satisfaction of the following conditions on\nor before the Closing Date:\ni. Corporate Name Change. All necessary corporate action on the part of the\ndirectors and stockholders of the Company approving the name change of the Company from \"Parade\nDeck\" to \"Alchify\" shall have been duly and validly taken.\nii. Stockholders'' Agreement. The stockholders of the Company shall have\nentered into a an amended and restated Stockholders'' Agreement for the Company revising the structure of\nthe Board of Directors.\n(b) Obligations of Sellers. At the Closing, Seller shall deliver to the Company (i) a\ncertificate or certificates evidencing the sufficient number of shares of Common Stock of the Company to\npermit the Company to transfer to Buyer a certificate evidencing the number of Purchased Shares to be\npurchased by Buyer from Seller, and (ii) the duly executed stock power attached to this Agreement as\nExhibit A (\"Stock Power\").\n(c) Obligations of Buyer. At the Closing, Buyer shall deliver (i) to Seller the Purchase\nPrice in immediately available funds by wire transfer in accordance with the wire transfer instructions\ndelivered by Seller to Buyer, and (ii) to the Company a duly executed joinder agreement to the\nStockholders'' Agreement in the form attached hereto as Exhibit C.\n3. Representations and Warranties of Seller. Seller hereby represents and warrants with\nrespect to the Purchased Shares owned by Seller as follows as of the date hereof and as of the Closing Date:\n(a) Title to the Shares. Seller is the lawful owner, beneficially and of record, of the\napplicable number of Purchased Shares and holds legal and equitable title to the Purchased Shares free and\nclear of any and all liens, claims, charges, pledges, encumbrances, security interests, equities, options, and\nrestrictions, except for the restrictions set forth in the Stockholders'' Agreement. The transfer of the\nPurchased Shares by Seller to Buyer pursuant to this Agreement is not subject to any right of first refusal,\npreemptive, tag-along, drag-along right, or other comparable obligations or restrictions with respect to the\ntransaction contemplated herein, that have not been complied with, waived, or voided.\n(b) Authority and Consent. Seller has the right, power, legal capacity, and authority\nto enter into and perform Seller''s obligations under this Agreement, and no approvals or consent of any\ngovernmental or regulatory authority or other persons is necessary in connection herewith.\n(c) No Violation or Breach. The execution and delivery of this Agreement and the\nconsummation of the transactions contemplated herein shall not violate or result in the breach by Seller of,\nor constitute a default under, or conflict with, or cause any acceleration of any obligation with respect to\nany provision or restriction of any material loan, mortgage, lien, agreement, contract, instrument, order,\njudgment, award, decree, or any other restriction of any kind or character to which any material assets or\nproperties of Seller is subject or by which Seller is bound.\n(d) Reliance on Advisors. Seller, in determining to sell the Shares, (i) understands that\nSeller may recognize taxable gain or loss as a result of the sale of the Shares, (ii) has been encouraged to\nand has had the opportunity to rely upon the advice of Seller''s legal and tax counsel, accountants, and other\nadvisors with respect to the sale of the Shares, and (iii) has relied solely upon the advice of Seller''s legal\nand tax counsel, accountants, or other financial advisors with respect to the financial, tax, and other\nconsiderations relating to the sale of the Shares.\n(e) Absence of Representations and Warranties. Seller confirms that neither the\nCompany nor anyone purportedly acting on behalf of the Company has made any representations,\nwarranties, agreements, or statements, express or implied, with respect to the Purchased Shares or the\nbusiness, affairs, financial condition, plans, or prospects of the Company nor has Seller relied on any\nrepresentations, warranties, agreements, or statements in the belief that they were made on behalf of any of\nthe foregoing.\n4. Representations and Warranties of Buyer. Buyer hereby represents and warrants as follows\nas of the date hereof and as of the Closing Date:\n(a) Authority and Consent. Buyer has the right, power, legal capacity, and authority\nto enter into and perform Buyer''s obligations under this Agreement, and no approvals or consent of any\ngovernmental or regulatory authority or other persons is necessary in connection herewith.\n(b) No Violation or Breach. The execution and delivery of this Agreement and the\nconsummation of the transactions contemplated hereby shall not violate or result in the breach by Buyer of,\nor constitute a default under, or conflict with, or cause any acceleration of any obligation with respect to\nany provision or restriction of any material loan, mortgage, lien, agreement, contract, instrument, order,\njudgment, award, decree, or any other restriction of any kind or character to which any material assets or\nproperties of Buyer is subject or by which Buyer is bound.\n(c) Purchase Entirely for Own Account. Buyer is acquiring the Purchased Shares for\nBuyer''s own account only and not with a view to, or for resale in connection with, any \"distribution\" of the\nPurchased Shares within the meaning of the Securities Act of 1933, as amended (the \"Securities Act\"), and\nBuyer has no contract, undertaking, or arrangement to sell or transfer the Purchased Shares to another\nperson.\n(d) Reliance on Advisors. Buyer, in determining to purchase the Purchased Shares,\n(i) has been encouraged to and has had the opportunity to rely upon the advice of Buyer''s legal and tax\ncounsel, accountants, and other advisors with respect to the purchase of the Purchased Shares, and (ii) has\nrelied solely upon the advice of Buyer''s legal and tax counsel, accountants, or other financial advisors with\nrespect to the financial, tax, and other considerations relating to the purchase of the Purchased Shares.\n(e) Absence of Representations and Warranties. Buyer confirms that neither the\nCompany nor anyone purportedly acting on behalf of the Company has made any representations,\nwarranties, agreements, or statements, express or implied, respecting the Purchased Shares or the business,\naffairs, financial condition, plans, or prospects of the Company nor has Buyer relied on any representations,\nwarranties, agreements, or statements in the belief that they were made on behalf of any of the foregoing.\n(f) No Company Representations. Buyer is not making any representations or\nwarranties to Seller in relation to or on behalf of the Company.\n(g) Shares to be Restricted. Buyer understands that the Purchased Shares are\n\"restricted securities\" within the meaning of Rule 144 under the Securities Act.\n(h) No Registration. Buyer acknowledges that the Purchased Shares have not been\nregistered under the Securities Act or the securities laws of any state, and the Purchased Shares cannot be\nresold unless the sale is registered or an exemption from registration is available. Buyer acknowledges that\nthe Company has no obligation to register or qualify the Purchased Shares for resale, and the Company\ndoes not intend to register any such Purchased Shares either under the Securities Act or any state securities\nlaws. Buyer further acknowledges that if an exemption from registration or qualification is available, it\nmay be conditioned on various requirements including, but not limited to, the time and manner of sale, the\nholding period for the Purchased Shares, and requirements relating to the Company which are outside of\nBuyer''s control, and which the Company is under no obligation and may not be able to satisfy.\n(i) Legends. Buyer acknowledges that the certificate evidencing the Purchased Shares\nshall bear a restrictive legend stating that the Purchased Shares may not be sold, transferred, hypothecated,\nor otherwise distributed in the absence of an effective registration under the Securities Act or any state\nsecurities laws or the receipt of an opinion of counsel satisfactory to the Company that such registration is\nnot required.\n(j) No General Solicitation or Advertising. The offer to sell the Purchased Shares was\ncommunicated directly to Buyer by Seller or Seller''s agent. At no time was Buyer presented with or\nsolicited by or through any article, notice, or other communication published in any newspaper or other\nleaflet, public promotional meeting, television, radio or other broadcast or transmittal advertisement or any\nother form of general solicitation or advertising.\n(k) Accredited Investor. Buyer is an Accredited Investor as defined in Rule 501(a) of\nRegulation D promulgated under the Securities Act. Buyer has completed and signed Exhibit B attached\nto this Agreement to provide Seller with information upon which Seller shall have a reasonable basis to\nbelieve that Buyer is an Accredited Investor. Buyer (i) can bear the economic risk of the purchase of the\nPurchased Shares, including the complete loss of Buyer''s investment, and (ii) has sufficient knowledge and\nexperience in business and financial matters as to be capable of evaluating the merits and risks of Buyer''s\npurchase of the Purchased Shares.\n5. Miscellaneous.\n(a) Incorporation of Recitals. The Recitals set forth above are incorporated by this\nreference and are expressly made part of this Agreement.\n(b) Further Assurances. Each of the parties hereto shall execute and deliver any and\nall such other instruments, documents, and agreements and take all such actions as either party may\nreasonably request from time to time in order to effectuate the purposes of this Agreement.\n(c) Controlling Law. This Agreement shall be governed exclusively by and construed\nin accordance with the laws of the state of Delaware without application of the conflict of laws principles\nthereof.\n(d) Binding Nature of Agreement; No Assignment. This Agreement shall be binding\nupon and inure to the benefit of the parties hereto and their respective successors and assigns, except that\nno party may assign or transfer its rights or obligations under this Agreement without the prior consent of\nthe other party hereto.\n(e) Entire Agreement. This Agreement contains the entire understanding between the\nparties hereto with respect to the purchase and sale of the Purchased Shares, and supersedes all prior and\ncontemporaneous agreements and understandings, inducements, or conditions, express or implied, oral or\nwritten, between the parties hereto, with respect to the purchase and sale of the Purchased Shares. This\nAgreement may not be modified or amended other than by an agreement executed in writing by Buyer and\nSeller.\n(f) Brokers and Finders. Each party represents and warrants to each other party that\nit has not employed or retained any broker or finder in connection with the transactions contemplated by\nthis Agreement nor has it had any dealings with any other person that may entitle such other person to a fee\nor commission from any other party hereto. Each party shall indemnify and hold the others harmless for,\nfrom, and against any claim, demand or damages whatsoever by virtue of any arrangement or commitment\nmade by it with or to any person that may entitle such person to any fee or commission from the other party\nto this Agreement.\n\n[REMAINDER OF PAGE INTENTIONALLY LEFT BLANK]\n\nIN WITNESS WHEREOF, Seller and Buyer have executed and delivered this Agreement as of the\nday and year first above written.\n\nSELLER:\nAddress: 413 Independence Ave SE, Washington DC 20003\nPersonal Email: appletonab@gmail.com\n\nBUYER:\nAddress: ___________________________\nPersonal Email: ___________________________\n\n[SIGNATURE PAGE TO COMMON STOCK PURCHASE AGREEMENT]\n\nEXHIBIT A\nSTOCK POWER\n\nSTOCK POWER\nFOR VALUE RECEIVED, the undersigned does hereby sell, convey, assign, and transfer unto\nthe transferees listed below, an aggregate of [NUMBER_OF_SHARES] shares of Common Stock, par value\n$0.0001 per share, of Parade Deck Holdings, Inc., a Delaware corporation (the \"Corporation\"), represented\nby Stock Certificate No. CS-1, and does hereby irrevocably constitute and appoint Weiss Brown, PLLC, to\ntransfer said stock on the books of the Corporation with full power of substitution in the premises:\n\nTransferee                    Number of Shares\n[PURCHASER_NAME]              [NUMBER_OF_SHARES]\n\nEXHIBIT B\nCERTIFICATE OF STATUS AS SOPHISTICATED OR ACCREDITED INVESTOR\n\nThe investor is acquiring the Shares as a Sophisticated Investor in a private shareholder-\nto-shareholder transaction exempt under Section 4(a)(1) of the Securities Act of 1933.\nBy signing below, the undersigned acknowledges and represents that:\n• They have been provided the opportunity to obtain any information necessary to evaluate\nthe investment;\n• They understand that the Shares are not registered under the Securities Act and are being\nacquired for investment purposes only;\n• They are able to bear the economic risk of loss of the entire investment; and\n• They consent to the Company relying on this representation for purposes of compliance\nwith federal and state securities laws.\n\nEXHIBIT C\nJOINDER AGREEMENT\n\nJOINDER AGREEMENT\nThe undersigned acknowledges intent to purchase shares of capital stock of PARADE\nDECK HOLDINGS, INC., a Delaware corporation (the \"Company\"). Reference is made to that\ncertain Stockholders'' Agreement, dated as of May 20, 2025 (the \"Stockholders'' Agreement\"), by\nand among the Company and the Stockholders as defined therein, as amended from time to time.\nThe undersigned further acknowledges that such purchase is subject to the joinder by the\nundersigned to the Stockholders'' Agreement, which provides significant benefits to the\nundersigned, the Company, and the Stockholders. Accordingly, pursuant to Section 6.15 of the\nStockholders'' Agreement, the undersigned hereby irrevocably and unconditionally agrees that, he,\nshe, or it, as the case may be, has as of the date hereof become a party to the Stockholders''\nAgreement in the capacity as a \"Stockholder,\" with all the attendant rights and obligations thereof,\nand with the same force and effect as though he or she, as the case may be, had originally been a\nsignatory thereto.\n\n[PURCHASER_NAME]\nAddress: ___________________________\nPersonal Email: ___________________________'
);